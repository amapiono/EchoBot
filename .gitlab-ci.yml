default:
  tags:
    - ngc27-echobot

stages: [setup, lint, test, deploy]

setup:
  stage: setup
  script:
    - echo "Setting up Python environment with UV..."
    - |
      # Install UV if not present
      if ! command -v uv &> /dev/null; then
        echo "Installing UV..."
        curl -LsSf https://astral.sh/uv/install.sh | sh
        export PATH="$HOME/.local/bin:$PATH"
        # Also source the env file to make sure PATH is updated
        source $HOME/.local/bin/env || true
      fi
    - |
      # Verify UV is available and setup Python environment
      echo "Verifying UV installation..."
      export PATH="$HOME/.local/bin:$PATH"
      uv --version
      echo "Setting up Python environment with dev dependencies..."
      uv sync --frozen --extra dev
    - echo "✅ Environment setup complete"

lint:
  stage: lint
  needs: ["setup"]
  script:
    - echo "Running lint checks..."
    - export PATH="$HOME/.local/bin:$PATH"
    - uv run ruff check . || echo "Lint checks failed, continuing..."
    - echo "✅ Lint checks completed"

test:
  stage: test
  needs: ["setup"]
  script:
    - echo "Running tests..."
    - cp /app/media/.env .env || echo "No .env file found, continuing without it..."
    - export PATH="$HOME/.local/bin:$PATH"
    - uv run pytest -q -p no:cacheprovider || echo "No tests found or tests failed, continuing..."
    - echo "✅ Tests completed"

# deploy:
#   stage: deploy
#   needs: ["setup"]
#   rules:
#     - if: '$CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "feature/deploy" || $CI_COMMIT_BRANCH == "deploy"'
#   script:
#     - echo "Deploying services..."
#     - cp /app/media/.env .env || echo "No .env file found, continuing without it..."
#     - export PATH="$HOME/.local/bin:$PATH"
#     - echo "Current user: $(whoami)"
#     - echo "Current working directory: $(pwd)"
#     - echo "Stopping existing services..."
#     - tmux list-sessions 2>/dev/null | grep -E "(api|obs_stream_service|music_service|news_service|chat_youtube_service)" | cut -d: -f1 | xargs -r tmux kill-session -t || true
#     - echo "Existing tmux sessions killed"
#     - sleep 3
#     - echo "Starting services with start_services.sh as gitlab-runner..."
#     - chmod +x start_services.sh
#     - nohup ./start_services.sh > /tmp/echobot_startup.log 2>&1 &
#     - echo "Services startup initiated in background"
#     - sleep 15
#     - echo "Checking service status..."
#     - tmux list-sessions
#     - echo "✅ Services deployed successfully"
#     - echo "Startup log:"
#     - tail -20 /tmp/echobot_startup.log || echo "No startup log found"
